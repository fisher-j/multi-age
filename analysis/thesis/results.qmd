---
execution:
  echo: false
---

# Results

```{r include=FALSE}
load("./fuel_data_modeling.rda")
load("./sprout_modeling.rda")
load("./regen_visualize.rda")

format_model_formula <- function(mod, component) {
  format(formula(mod, component = component)) |>
    paste0(collapse = "") |>
    str_replace("\\s{2,}", " ")
}

print_model_info <- function(mod) {
  cat(
    "Family: ", mod$modelInfo$family$family, "\n",
    "Link: ", mod$modelInfo$family$link, "\n",
    "Conditional: ", format_model_formula(mod, "cond"), "\n",
    "Dispersion: ", format_model_formula(mod, "disp"), "\n",
    "Hurdle: ", format_model_formula(mod, "zi"), "\n"
  )
}

species_labels <- c(LIDE = "Tanoak", SESE = "Redwood")
year_labels <- c(`1` = "Year 1", `5` = "Year 5", `10` = "Year 10")
plot_labels <- labeller(
  spp = species_labels,
  year =  year_labels
)

standard_model_col_names <- c(
  LCL = "lower.CL", UCL = "upper.CL", LCL = "asymp.LCL", UCL = "asymp.UCL",
  emmean = "response", emmean = "the.emmean", treat = "treatment"
)

# produce comparisons of emmeans grid and convert to a data frame to plot the
# results
emm_to_df <- function(emm) {
  plot(emm, comparisons = TRUE, plotit = FALSE) |>
  as_tibble() |>
  rename(any_of(standard_model_col_names))
}

# Common mapping for all plots, allows for specification of x-axis variable
emm_mapping <- function(x = treat) {
  aes({{x}}, emmean, ymin = LCL, ymax = UCL, xend = {{x}})
}

# Common elements of all plots: comparison arrows, and CI's 
draw_emm <- function(data = ., position = "identity") {
  list(
    geom_linerange(
      color = "gray70",
      linewidth = 2.3,
      show.legend = FALSE,
      position = position
    ),
    geom_segment(
      aes(yend = rcmpl),
      color = "#4444d1",
      lineend = "butt",
      linejoin = "bevel",
      arrow = arrow(length = grid::unit(2.5, "mm")),
      linewidth = 1,
      na.rm = TRUE,
      position = position
    ),
    geom_segment(
      aes(yend = lcmpl),
      color = "#4444d1",
      lineend = "butt",
      linejoin = "bevel",
      arrow = arrow(length = grid::unit(2.5, "mm")),
      linewidth = 1,
      na.rm = TRUE,
      position = position
    ),
    geom_point(color = "black", size = 2, position = position)
  )
}

```

## Fuels

### Pre-pct

Gamma distributed, linear multi-level models, with a log link were used for all
six fuel class responses. Random intercepts were specified for three levels of
nesting, representing sites, treatment blocks, and transect corners. All models
except for the duff & litter model included a hurdle model to account for
zero, which was modeled with a logit link. For the 10-hr fuel model, the hurdle
portion was modeled as a function of treatment, and for the others, it was
modeled as a single rate for all observations. The 10-hr fuel model also
included a dispersion model, which was modeled with a log link, using treatment
as a predictor.

```{r}

fuel_tmb$pre |>
  transmute(
    class = class,
    Family = mod$modelInfo$family$family,
    Link = mod$modelInfo$family$link,
    Conditional = format_model_formula(mod, "cond"),
    "Dispersion (log)" = format_model_formula(mod, "disp"),
    "Hurdle (logit)" = format_model_formula(mod, "zi")
) |> tinytable::tt()

```

For Duff & Litter, the largest difference was between the HD and HA treatments.
The HD treatment had about 1.4 times more duff and litter (p = 0.07). Generally,
all treatments were similar, with estimated loading of around 50 Mg ha-1.
One-hour fuels were around 50% higher in the HA treatment compared to the LD and
GS treatments (p = 0.07, and p = 0.01, respectively), with mean differences of
around 0.5 Mg ha-1. Ten, hundred and thousand-hour fuels were statistically,
very similar across treatments (p = 0.7 — p = 1). Point esimates varied by about
1, 3, and <20 Mg ha-1 for ten, hundred, and thousand-hour fuels, respectively.

```{r}
#| fig-width: 8
#| fig-cap: >
#|   Estimated marginal means (black dots) confidence intervals (gray bands) and
#|   comparisons (blue arrows) of fuel loading across four treatments for six
#|   different fuel-class models. Non-overlapping blue arrows indicates
#|   statistical significance at the α = 0.05 level.

fuel_tmb$pre |>
  mutate(class = case_match(as.character(class), !!!class_labels2)) |>
  group_map(function(x, ...) {
    emm_to_df(x$.emmeans[[1]]) |>
    ggplot(emm_mapping()) +
    draw_emm() +
    scale_x_discrete(labels = toupper) +
    labs(title = x$class, x = expression(Load~(Mg%.%ha^-1)), y = "Treatment")
  }) |>
  patchwork::wrap_plots() + patchwork::plot_layout(axes = "collect")

```

### Post-pct

The response for all six, post-pct fuel classes were modeled with a gamma
distribtuion and a log link, and included the same multi-level random effects as
for the pre-pct models. Dispersion models with treatment as the only predictor
were included for 1-hr and 100-hr fuel classes. All modeles included a hurdle
portion to model zeros using a logit link. For 100-hr fuels, this model included
treatment and site as predictors, and for the rest, a constant rate for all
observations was used.

```{r}

fuel_tmb$post |>
  transmute(
    class = class,
    Family = mod$modelInfo$family$family,
    Link = mod$modelInfo$family$link,
    Conditional = format_model_formula(mod, "cond"),
    "Dispersion (log)" = format_model_formula(mod, "disp"),
    "Hurdle (logit)" = format_model_formula(mod, "zi")
) |> tinytable::tt()

```

Post-pct resulted in greater stratification of treatments. One-hour fuels were
generally around 2.4 Mg ha^-1^, but the HA treatment had around half of that
amount (p = 0.01 --- p = 0.02). The GS treatment had the greatest 10-hr fuel
loading with 8.8 Mg ha^-1^, which was about 1.6, 2.3 and 2.9 times greater than
the LD, HA, and HD treatments respectively (p = 0.03, p < 0.001, for the others,
respectively). The LD treatment also had about 1.7 times more 10-hr fuels that
the HD treatment (5.4 vs. 3 Mg ha^-1^, p = 0.001). Hundred-hour fuels were also
greatest in the GS treatment, with an average of about 19 Mg ha^-1^, which was
about 2.6 times greater than in the HD treatment (7 Mg ha^-1^, p < 0.001).
Thousand-hour fuels were greatest in the HD treatment, with 80 Mg ha^-1^, which
was about 2.7 times greater than the LD and HD treatments (p = 0.03 and p = 0.05,
respectively). Fuel loading for live vegetation was similar across treatments at
around 2.5 Mg ha^-1^. The pre-post vegetation difference was greatest in the GS
treatment at about 31 Mg ha^-1^, which was 2.5 and 2.8 times the HD and HA
treatments, respectively (p ≈ 0.01).

```{r}
#| fig-width: 8
#| fig-cap: >
#|   Estimated marginal means (black dots) confidence intervals (gray bars) and
#|   comparisons (blue arrows) of fuel loading across four treatments for six
#|   different fuel-class models. Non-overlapping red arrows indicates
#|   statistical significance at the α = 0.05 level. Vegetation difference
#|   equals the transect level difference in vegetation load in the pre and
#|   post-pct conditions. This represents slash fuels recruited to the forest
#|   floor following the pre-commercial thinning.

fuel_tmb$post |>
  mutate(class = case_match(as.character(class), !!!class_labels2)) |>
  group_map(function(x, ...) {
  emm_to_df(x$.emmeans[[1]]) |>
  ggplot(emm_mapping()) +
  draw_emm() +
  scale_x_discrete(labels = toupper) +
  labs(title = x$class, x = expression(Load~(Mg%.%ha^-1)), y = "Treatment")
  }) |>
  patchwork::wrap_plots() + patchwork::plot_layout(axes = "collect")

```

## Sprout heights

### Height increment

The selected height increment model used a normal response distribution on the
identity link. It included treatment, growth period, species, and the
interaction of species and growth period as fixed effects. A random intercept
was included for tree (multiple observations) and macro-plot, and a random slope
was included for species. The dispersion parameter for the response was modeled
(with a log link) as a function of treatment, growth period, species and all
three-way interactions.  

```{r}

cat(
  "Family:", paste0(
    minc_sel$modelInfo$family$family, " (",
    minc_sel$modelInfo$family$link,  ")"
  ), "\n",
  "Conditional:", format_model_formula(minc_sel, "cond"), "\n",
  "Dispersion:", format_model_formula(minc_sel, "disp")
)

```

The model selected based on AIC lacks a treatment x species interaction,
suggesting that there is not evidence that treatments affected species
differentially. It also lacks a treatment x year interaction. This means that
there was not enough evidence to support that treatment was related to changes
in growth rate.

The presence of treatment in the model (0.001 ≤ p < 0.03) suggests that
the levels of treatment were associated with different growth rates across
species and years. And the species x year interaction (p < 0.001) suggests
changes in growth rates are different for redwood and tanoak.

Averaging over growth periods, treatment specific height increments for redwood
ranged from 0.66 to 0.86 m yr^-1^, and for tanoak, from 0.29 to 0.49, with the
slowest growth in the HD treatment and the fastest in the GS treatment. height
increment was greater in the GS treatment than the HA and HD treatments by about
0.19 m yr^-1^ (p < 0.001). The LD treatment was intermediate, but not
statistically distinguishable from the other treatments (0.13 < p < 0.28).

```{r}
#| label: fig-sprout-inc-treat
#| fig-cap: >
#|   Estimated marginal means for the effect of harvest treatment on redwood and
#|   tanoak sprout height increment, averaged over two growth periods, ten years
#|   after harvest. Gray bars represent confidence intervals and statistical
#|   significance (α = 0.05) is indicated by non-overlaping blue arrows.

emm_treat <- emmeans(minc_sel, "treat", by = "spp")
plot(emm_treat, comparisons = TRUE)

emmeans(minc_sel, "treat", by = "spp") |>
  emm_to_df() |>
  ggplot(aes(treat, emmean)) +
  draw_emm() +
  facet_wrap(~ spp, labeller = plot_labels) +
  labs(x = "Treatment", y = expression(Height~Increment~(m%.%yr^-1)))

```

Redwood growth slowed from 0.80 to 0.67 m yr^-1^ in the second period and tanoak
slowed from 0.39  to 0.34 m yr^-1^.

Redwood grew faster than tanoak, but slowed down more relative to it in the
second period. Height increment for redwood was 0.42 m yr^-1^ greater in the
first period and 0.33 m yr^-1^ greater in the second period than tanoak height
increment.


```{r}
#| label: fig-sprout-inc-year
#| fig-cap: >
#|   Estimated marginal means for the effect of growth period on redwood and
#|   tanoak sprout height increment, averaged over four harvest treatments, from
#|   years 1 to 5, and years 5 to 10 after harvest, plotted alongside actual
#|   data. Gray bars represent confidence intervals and statistical significance
#|   (α = 0.05) is indicated by non-overlaping blue arrows.

emmeans(minc_sel, c("year"), by = "spp") |>
  emm_to_df() |>
  ggplot(emm_mapping(x = year)) +
  draw_emm(position = position_nudge(x = -0.15)) +
  geom_dots(data = dinc, aes(year, ht_inc, ymin = NULL, ymax = NULL), alpha = 0.4) +
  facet_wrap(~ spp, labeller = plot_labels) +
  scale_x_discrete(labels = c(`5` = "1 - 5", `10` = "5 - 10")) +
  labs(
    x = "Growth Period (years)",
    y = expression(Height ~ increment ~ (m %.% year^-1))
  )

```

### Height at year 10

Sprout heights at year 10 were modeled with a normal response and a log link.
The best model included speceis and treatment, but no interactions in the fixed
effects. This suggests that treatments do not affect species differentially. It
also included a model for dispersion (log link) that had species, treatment, and
their interaction as predictors.

```{r}

cat(
  "Family:", paste0(
    ht10_sel$modelInfo$family$family, " (",
    ht10_sel$modelInfo$family$link,  ")"
  ), "\n",
  "Conditional:", format_model_formula(ht10_sel, "cond"), "\n",
  "Dispersion:", format_model_formula(ht10_sel, "disp")
)

```

Because the best model did not contain a species x treatment interaction,
comparisons between treatments is the same for both species. The GS treatment
resulted in greater heights in year 10 than the other treatments (0.001 < p <
0.04). Predicted mean height for redwood ranged from 10.29 m in the GS treatment
to 6.16 m in the HD treatment. For tanoak, predicted mean height ranged from
5.12 in the GS treatment to 3.04 in the HD treatment. Predicted mean heights
followed the pattern GS > LD > HA > HD.

```{r}
#| label: fig-year-10-only
#| fig-cap: >
#|   Predicted mean height and 95% confidence intervals (gray bars) for redwood
#|   and tanoak stump sprouts 10 years after harvest using four different
#|   harvest treatments. Non-overlaping blue arrows indicate statistically
#|   significant differences between treatments within a species.

emmeans(ht10_sel, "treat", by = "spp", type = "response") |>
  emm_to_df() |>
  ggplot(emm_mapping()) +
  draw_emm(position = position_nudge(x = -0.07)) +
  geom_dots(
    data = filter(dht, year == 10),
    aes(x = treat, y = ht),
    inherit.aes = FALSE
  ) +
  facet_wrap(~ spp, labeller = plot_labels) +
  labs(x = "Treatment", y = "Height (m)")

```

## Regeneration composition



```{r}

cat(
  "Family:", paste0(
    mba_sel$modelInfo$family$family, " (",
    mba_sel$modelInfo$family$link,  ")"
  ), "\n",
  "Conditional:", format_model_formula(mba_sel, "cond"), "\n",
  "Dispersion:", format_model_formula(mba_sel, "disp")
)

```

