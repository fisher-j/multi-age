---
execute:
  echo: false
---

# Results

```{r include=FALSE}

load("./fuel_modeling_round_3.rda")
load("./sprout_modeling.rda")
load("./regen_visualize.rda")

library(emmeans)
library(ggdist)
library(purrr)
library(stringr)
library(tibble)
library(dplyr)
library(tidyr)
library(tidyselect)
library(ggplot2)
library(tibble)
library(patchwork)
library(tinytable)
library(marginaleffects)
```

```{r}

# Given a glmmTMB model and one of "cond", "disp", or "zi", print model formula
# optionally including labels and link functions
format_model_formula <- function(mod, component, label = FALSE) {
  comp_label <- switch(
    component,
    cond = c("Conditional:", ""),
    disp = c("Dispersion:", "(log)"),
    zi = c("Hurdle:", "(logit)")
  )
  form <- format(formula(mod, component = component)) |>
    paste0(collapse = "") |>
    str_replace("\\s{2,}", " ")
  if (label) {
    return(paste(comp_label[1], form, comp_label[2]))
  }
  form
}

# given a glmmTMB model and extra component model types, print conditional and
# component model formula and link functions
print_model_info <- function(mod, components = c("disp", "zi")) {
  comp <- c("cond", components)
  fam <- paste0(
    "Family: ",
    mod$modelInfo$family$family,
    " (",
    mod$modelInfo$family$link,
    ")"
  )
  cat(fam, "\n")
  walk(comp, \(x) cat(format_model_formula(mod, x, label = TRUE), "\n"))
}

treat_labels <- c(gs = "GS", ld = "LD", ha = "HA", hd = "HD")
species_labels <- c(
  LIDE = "Tanoak",
  SESE = "Redwood",
  other = "Other",
  df = "Douglas-fir",
  rw = "Redwood",
  to = "Tanoak"
)
year_labels <- c(`1` = "Year 1", `5` = "Year 5", `10` = "Year 10")

plot_labels <- labeller(
  spp = species_labels,
  year = year_labels,
  treat = treat_labels
)

standard_model_col_names <- c(
  `95% LCL` = "lower.CL",
  `95% UCL` = "upper.CL",
  `95% LCL` = "asymp.LCL",
  `95% UCL` = "asymp.UCL",
  Emmean = "response",
  Emmean = "the.emmean",
  Treat = "treatment",
  Emmean = "estimate",
  `95% LCL` = "conf.low",
  `95% UCL` = "conf.high",
  `Spp` = "spp",
  Contrast = "contrast",
  Estimate = "estimate",
  DF = "df",
  `P value` = "p.value",
  Class = "class"
)

############### For package emmeans #################
# produce comparisons of emmeans grid and convert to a data frame to plot the
# results
emm_to_df_emm <- function(emm) {
  plot(emm, comparisons = TRUE, plotit = FALSE) |>
    as_tibble() |>
    rename(any_of(standard_model_col_names))
}


############### For package marginaleffects ###############
# convert predictions to a data frame to plot the
# results
emm_to_df <- function(emm) {
  emm |>
    as_tibble() |>
    rename(any_of(standard_model_col_names))
}
############################################################

# Common mapping for all plots, allows for specification of x-axis variable
emm_mapping <- function(x = treat, group = NULL, color = NULL) {
  # nolint
  aes(
    {{ x }},
    Emmean, # nolint
    ymin = `95% LCL`, # nolint
    ymax = `95% UCL`, # nolint
    xend = {{ x }},
    group = {{ group }},
    color = {{ color }}
  )
}

############### For package emmeans ###############
# Common elements of all plots: comparison arrows, and CI's
draw_emm_emm <- function(data = ., position = "identity", show_legend = FALSE) {
  list(
    geom_linerange(
      color = "gray70",
      linewidth = 2.3,
      show.legend = show_legend,
      position = position
    ),
    geom_segment(
      aes(yend = rcmpl),
      color = "#4444d1",
      lineend = "butt",
      linejoin = "bevel",
      arrow = arrow(length = grid::unit(2.5, "mm")),
      linewidth = 1,
      na.rm = TRUE,
      position = position
    ),
    geom_segment(
      aes(yend = lcmpl),
      color = "#4444d1",
      lineend = "butt",
      linejoin = "bevel",
      arrow = arrow(length = grid::unit(2.5, "mm")),
      linewidth = 1,
      na.rm = TRUE,
      position = position
    ),
    geom_point(
      color = "gray95",
      shape = "circle filled",
      size = 2,
      stroke = 1.2,
      fill = "black",
      position = position
    )
  )
}

############### For package marginaleffects #################
# Common elements of all plots: comparison arrows, and CI's
draw_emm <- function(
  data = .,
  position = position_dodge(width = .7),
  show_legend = FALSE
) {
  list(
    geom_linerange(
      color = "#a0a0d1",
      linewidth = 2.3,
      show.legend = show_legend,
      position = position
    ),
    geom_point(
      color = "white",
      shape = "circle filled",
      size = 2,
      fill = "black",
      position = position
    )
  )
}

############################################################

# This is just for the last plot with combined pre and post treatments
draw_emm2 <- function(data = ., position = position_dodge(width = .7)) {
  list(
    geom_linerange(
      linewidth = 2.3,
      position = position
    ),
    geom_point(
      color = "white",
      shape = "circle filled",
      size = 2,
      fill = "black",
      position = position
    )
  )
}

# This is a wrapper function to get the emmeans object from the marginaleffects
# if a by_var is specified, it will return a nested tibble of emmeans objects
# for each level of the by_var. Otherwise, it will return a single emmeans
# object.
marginaleffects_to_emmeans <- function(
  model,
  newdata,
  x_var,
  by_var,
  contrast
) {
  # accept a list of argument to datagrid
  if (is.list(newdata) && !is.data.frame(newdata)) {
    newdata$model <- model
    newdata <- do.call(datagrid, newdata)
  }
  # handle multiple groups if by_var is specified
  if (is.null(by_var)) {
    by <- x_var
  } else {
    by <- c(by_var, x_var)
  }
  pred <- predictions(
    model,
    newdata = newdata,
    re.form = NULL,
    by = by
  )
  comp <- comparisons(
    model,
    newdata = newdata,
    variables = contrast,
    by = c(by_var, "contrast"),
    re.form = NULL
  )
  # return a single emmobj if by_var is NULL, otherwise return a nested tibble
  if (!is.null(by_var)) {
    pred <- pred |>
      group_by(!!sym(by_var)) |>
      tidyr::nest(.key = "pred")
    comp <- comp |>
      group_by(!!sym(by_var)) |>
      tidyr::nest(.key = "comp")
    left_join(by = by_var, pred, comp) |>
      rowwise() |>
      mutate(emmobj = list(get_emmobj(pred, comp, x_var)))
  } else {
    get_emmobj(pred, comp, x_var)
  }
}
```

The formulas below use $\beta$ to represent fixed effects and $\alpha$ to
represent random effects. Subscripts indicate the variable associated with each
effect. Superscripted Greek letters indicate the model component where fixed or
random effects are present in more than one component (e.g., $\mu$ for the
conditional model, $\pi$ for the hurdle model, and $\phi$ for the dispersion
model). A "hurdle gamma" distribution is used for models of basal area and fuels
and is defined below.

$$
\text{hurdle\_gamma}(y_i \mid \pi_i, \mu_i, \phi_i) = 
\begin{cases}
1-\pi_i & \text{if } y_i = 0 \\
\pi_i \cdot \text{Gamma}(y_i \mid \mu_i, \phi_i) & \text{if } y_i > 0
\end{cases}
$$


## Regeneration

### Basal area

Composition of regeneration in terms of basal area per acre represented by each
species in a 4-meter radius vegetation plot was modeled as a gamma distribution
with a log link with fixed effects for treatment and species, and random
intercepts for site x species interaction. Dispersion was modeled separately as
a function of species, using a log link and the rate of zeros was modeled using
the logit link, for each species as well:

::: {#lst-regen-ba}
```{r}
print_model_info(mba)
```
::: 

$$
Y_i \sim \text{hurdle\_gamma}(\pi_i, \mu_i, \phi_i)
$$

$$
\text{logit}(\pi_i) = \beta^{\pi}_0 + \beta^{\pi}_{\text{spp}} \cdot \text{Species}_i
$$

$$
\log(\mu_i) = \beta^{\mu}_0 + \beta^{\mu}_{\text{trt}} \cdot \text{Trt} + \alpha_{j[i]}
$$

$$
\log(\phi_i) = \beta^{\phi}_0 + \beta^{\phi}_{\text{spp}} \cdot \text{Species}_i
$$

$$
\alpha_j \sim N(0, \sigma^2_j)
$$


- $Y_i$: Total basal area per hectare for each species in a 4-meter radius
  regeneration plot.
- $\pi_i$: Probability that $Y_i > 0$
- $\mu_i$: Mean of positive values.
- $\phi_i$: Dispersion parameter for Gamma distribution
- $\alpha_j$: Group effect pertaining to a site:species interaction


```{r}
regen_all <- marginaleffects_to_emmeans(
  mba,
  list(spp = unique, treat = unique, site = unique),
  x_var = "treat",
  by_var = "spp",
  contrast = list(treat = "pairwise")
) |>
  mutate(emm = list(emmeans::emmeans(emmobj, ~level) |> as_tibble()))

regen_grand_means <- regen_all |>
  dplyr::mutate(
    grand_mean = list(
      emmeans(emmobj, ~1) |>
        as_tibble() |>
        mutate(across(where(is.double), ~ round(.x, 2)))
    )
  ) |>
  select(spp, grand_mean)

# make data easier to work with by recursively converting nested tibbles to
# named lists. I'm using emmeans::pairs() to get the pairwise comparisons
# because it incorporates a tukey adjustment for multiple comparisons.
regen_pairs <-
  regen_all |>
  mutate(
    pairs = list(
      pairs(emmobj) |>
        as_tibble() |>
        mutate(across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = contrast) |>
        deframe()
    )
  ) |>
  select(spp, pairs) |>
  deframe()

regen_mean <-
  regen_all |>
  mutate(
    emm = list(
      mutate(emm, across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = level) |>
        deframe()
    )
  ) |>
  select(spp, emm) |>
  deframe()

regen_grand <- deframe(regen_grand_means)
```

Focal species for this model included redwood, tanaok, Douglas-fir, and other
species. 

Redwood regeneration basal area showed the greatest treatment response. 
The GS treatment had the greatest basal area of redwood regeneration at 
`r regen_mean$rw$gs$estimate` m^2^ ha^-1^, which was 
`r abs(regen_pairs$rw[["gs - hd"]]$estimate)` m^2^ ha^-1^ greater than in the HD
treatment (p = `r pluck(regen_pairs, "rw", "gs - hd", "p.value")`). The LD and
HD treatments were intermediate.

Tanoak regeneration basal area was intermediate between that of redwood and
Douglas-fir and other species. The GS and LD treatments had similar responses, as
did the HA and HD treatments. The GS treatment resulted in `r regen_mean$to$gs$estimate` 
m^2^ ha^-1^ of tanoak basal area, which was `r regen_pairs$to[["gs - ha"]]$estimate`
m^2^ ha^-1^ greater than in the HA treatment 
(p = `r pluck(regen_pairs, "to", "gs - ha", "p.value")`).

On average, for Douglas-fir, we expect about `r regen_grand$df$estimate` m^2^
ha^-1^ of basal area across treatments. The greatest basal area of Douglas-fir
was in the GS treatment which was `r abs(regen_pairs$df[["gs - ha"]]$estimate)`
m^2^ ha^-1^ greater than in the HA treatment 
(p = `r pluck(regen_pairs, "df", "gs - ha", "p.value")`). The LD, HA, and HD
treatments were all comparatively similar.

Other species included grand fir, madrone, and California wax-myrtle,
of which there was a total of 23, 28, and 16 observations across our 16 macro
plots (comprising 64 tree density plots). Generally, each plot had between 0 and
9 observations of other species, except for one macro plot with the LD
treatment, which had 16 observations (data not shown).

According to predictions made from this model for other species, there was not
enough evidence to confirm a statistically significant difference between
treatments. On average, we expect about `r regen_grand$other$estimate` m^2^
ha^-1^ of basal area across treatments. The greatest basal area of other species
was in the HD treatment which was `r abs(pluck(regen_pairs, "other", "ha - hd", "estimate"))`
m^2^ ha^-1^ greater than in the HA treatment 
(p = `r pluck(regen_pairs, "other", "ha - hd", "p.value")`). The GS and LD
treatments were intermediate.

```{r}
#| label: tbl-regen-ba-grand-means
#| tbl-cap: >
#|   Grand means (m^2^ ha^-1^) for basal area of regeneration of each species
#|   across treatments 10 years after the initiation of a multiaged redwood
#|   forest. The asymptotic 95% confidence intervals are based on the normal
#|   approximation.

regen_grand_means |>
  unnest(grand_mean) |>
  rename(any_of(standard_model_col_names)) |>
  select(-c("1", "DF")) |>
  tinytable::tt()
```

```{r}
#| label: fig-regen-ba
#| fig-cap: >
#|   Basal area (m^2^ ha^-1^) modeled at the vegetation plot level for four
#|   harvest treatments and four species classes (n = 16). Gray bars represent
#|   the 95% confidence interval (α = 0.05), black dots indicate the mean, and
#|   blue arrows provide a means of assessing the statistical significance of
#|   pairwise differences among treatments. Arrows are drawn so that when two
#|   arrows just meet, the p-value for that difference is 0.05 and overlapping
#|   arrows indicate a p-values greater than 0.05. Note: Y-axes vary by species.

regen_all |>
  mutate(emm_df = list(emm_to_df_emm(emmobj))) |>
  select(spp, emm_df) |>
  unnest(emm_df) |>
  ggplot(emm_mapping(x = level)) +
  facet_wrap(~spp, ncol = 2, labeller = plot_labels, scales = "free") +
  draw_emm_emm() +
  scale_x_discrete(labels = toupper) +
  labs(x = "Treatment", y = expression(Basal ~ Area ~ (m^2 %.% ha^-1)))
```

```{r}
#| label: tbl-regen-ba
#| tbl-cap: >
#|   Basal area (m^2^ ha^-1^) modeled at the vegetation plot level for four
#|   harvest treatments and four species classes (n = 16). The asymptotic 95%
#|   confidence intervals are based on the normal approximation.

regen_all |>
  select(spp, emm) |>
  unnest(everything()) |>
  rename(treatment = level, any_of(standard_model_col_names)) |>
  select(-c("DF")) |>
  tinytable::tt() |>
  tinytable::format_tt(digits = 2, num_fmt = "decimal")
```

```{r}
#| label: tbl-regen-ba-compare
#| tbl-cap: >
#|   Pairwise comparisons of treatments within species. P-values were adjusted
#|   using the Tukey method for comparing families of four estimates and they
#|   are based on large-sample (asymptotic) normal approximations.

regen_all |>
  mutate(
    emm = list(pairs(emmobj) |> as_tibble())
  ) |>
  select(spp, emm) |>
  unnest(emm) |>
  select(-c(z.ratio, df)) |>
  rename(any_of(standard_model_col_names)) |>
  tinytable::tt() |>
  tinytable::format_tt(digits = 2, num_fmt = "decimal")
```

```{r}

regen_rw_to <- marginaleffects_to_emmeans(
  mba,
  list(spp = c("rw", "to"), treat = unique, site = unique),
  x_var = "spp",
  by_var = "treat",
  contrast = list(spp = c("to", "rw"))
)

# get contrasts in a format that is easy to work with: lists instead of grouped
# tibbles
rw_to_pairs <-
  regen_rw_to |>
  mutate(
    pairs = list(
      pairs(emmobj) |>
        as_tibble() |>
        mutate(across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = contrast) |>
        deframe()
    )
  ) |>
  select(treat, pairs) |>
  deframe()

rw_to_mean <-
  regen_rw_to |>
  mutate(
    emm = list(
      emmeans(emmobj, ~level) |>
        as_tibble() |>
        mutate(across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = level) |>
        deframe()
    )
  ) |>
  select(treat, emm) |>
  deframe()
```

@fig-regen-ba-rw-to shows the same model as @fig-regen-ba, but with an emphasis
on treatment comparisons between redwood and tanoak. 
This shows that we expect on average, 
`r abs(rw_to_pairs$gs[[1]]$estimate)` m^2^ ha^-1^ greater redwood basal area
than tanoak basal area in the GS treatment (p = `r rw_to_pairs$gs[[1]]$p.value`),
about `r abs(rw_to_pairs$ld[[1]]$estimate)` m^2^
ha^-1^ in the LD treatment (p = `r rw_to_pairs$ld[[1]]$p.value`), and about 
`r abs(rw_to_pairs$ha[[1]]$estimate)` m^2^ ha^-1^ in the HA treatment 
(p = `r rw_to_pairs$ha[[1]]$p.value`). In the HD treatment, we expect to see
slightly higher tanoak basal area (p = `r abs(rw_to_pairs$hd[[1]]$p.value)`).

Uncertainty in average redwood basal area across sites, indicated by the size of
95% confidence intervals, is much greater than that of tanoak in the GS
treatment, but this difference diminishes such that GS > LD > HA > HD (@fig-regen-ba-rw-to). In the HD
treatment redwood and tanoak average basal area uncertainty across sites is very
similar.

```{r}
#| label: fig-regen-ba-rw-to
#| fig-cap: >
#|   Basal area (m^2^ ha^-1^) modeled at the vegetation plot level for four
#|   harvest treatments and two species classes (n = 16). Gray bars represent
#|   the 95% confidence interval, black dots---the mean, and non-overlapping
#|   blue arrows signify statistical significance (α = 0.05).

regen_rw_to |>
  mutate(emm_df = list(emm_to_df_emm(emmobj))) |>
  select(treat, emm_df) |>
  unnest(emm_df) |>
  ggplot(emm_mapping(x = level)) +
  facet_wrap(~treat, ncol = 2, labeller = plot_labels, scales = "free") +
  draw_emm_emm() +
  scale_x_discrete(labels = species_labels) +
  labs(x = "Species", y = expression(Basal ~ Area ~ (m^2 %.% ha^-1)))
```

### Douglas-fir counts

Counts of regenerating Douglas-fir seedlings per vegetation plot were
analyzed for differences between harvest treatments using a negative binomial
response with a log link, fixed effects for treatment, random effects for sites
and macro plots within sites.

::: {#lst-df-counts}
```{r}
print_model_info(mdf, NULL)
```
:::

$$
Y_i \sim \text{NB1}(\mu_i, \phi); \quad \text{where} \quad Var(Y_i) = \mu_i +
\phi \mu_i
$$

$$
\log(\mu_i) = \beta_0 + \beta_{\text{trt}} \cdot \text{Trt}_i +
\alpha_{j[i]} + \alpha_{k[i]}
$$

$$
\alpha_{j} \sim \operatorname{N}(0, \sigma^2_{j}), \quad \alpha_{k} \sim \operatorname{N}(0, \sigma^2_{k})
$$

- $Y_i$: Count of Douglas-fir seedlings in a 4-meter radius vegetation plot.
- $\mu_i$: The expected count for vegetation plot $i$.
- $\beta_{\text{trt}}$: Fixed effect for harvest treatment.
- $\alpha_j$: Random intercept for site.
- $\alpha_k$: Random intercept for plots within sites. 

This model for Douglas-fir counts does not indicate any statistically
significant differences between treatments. Generally, we expect about 2
seedlings per 4-meter-radius plot, or about 413 seedlings per hectare
(@fig-df-counts).

```{r}
#| label: fig-df-counts
#| fig-cap: >
#|   Expected marginal means of vegetation plot level counts of regenerating
#|   Douglas-fir seedlings in four harvest treatments 10 years after harvest (n
#|   = 16). Results have been scaled to stems per hectare (4-meter radius
#|   plots). The asymptotic 95% confidence intervals are based on the normal
#|   approximation.

df_counts <- marginaleffects_to_emmeans(
  model = mdf,
  newdata = list(treat = unique, site = unique),
  x_var = "treat",
  by_var = NULL,
  contrast = list(treat = "pairwise")
)

emm_to_df_emm(df_counts) |>
  mutate(across(where(is.double), \(x) x * per_ha["corner"])) |>
  ggplot(emm_mapping(x = level)) +
  draw_emm_emm()
```

```{r}
#| label: tbl-df-counts
#| tbl-cap: >
#|   Vegetation plot level counts of regenerating Douglas-fir seedlings in four
#|   harvest treatments 10 years after harvest (n = 16). Results have been
#|   scaled to stems per hectare from 4-meter radius plots. The asymptotic 95%
#|   confidence intervals are based on the normal approximation.

emmeans(df_counts, "level") |>
  as_tibble() |>
  mutate(level = as.character(level)) |>
  mutate(across(where(is.double), \(x) x * per_ha["corner"])) |>
  select(Treatment = level, !c(SE, df)) |>
  tinytable::tt(digits = 2)
```

## Sprout heights

In the following two models, a random slope for species is included for each
macro plot. This specifies a general (unstructured) covariance matrix that
allows the random effect variance to differ by species (heteroscedasticity) and
allows for non-zero correlations between species-level effects within the same
plot (e.g., assessing if plots that are favorable for one species are also
favorable for others). This variance-covariance matrix takes the following form,
where $A$, $B$, and $C$ represent different species.

$$
\boldsymbol{\Sigma}_{\text{macro}} =
\begin{pmatrix}
\sigma_A^2 & \rho_{AB}\sigma_A\sigma_B & \rho_{AC}\sigma_A\sigma_C \\
\rho_{AB}\sigma_A\sigma_B & \sigma_B^2 & \rho_{BC}\sigma_B\sigma_C \\
\rho_{AC}\sigma_A\sigma_C & \rho_{BC}\sigma_B\sigma_C & \sigma_C^2
\end{pmatrix}
$$

### Height increment

The selected height increment model used a normal response distribution on the
identity link. It included treatment, growth period, species, and the
interaction of species and growth period as fixed effects. A random intercept
was included for tree (multiple observations) and macro-plot, and another
random effect allowed the response to vary by species differently for each macro
plot. The dispersion parameter for the response was modeled (with a log link) as
a function of treatment, growth period, species and all three-way interactions
(@lst-sprout-ht-inc).  

::: {#lst-sprout-ht-inc}
```{r}
print_model_info(minc_sel, "disp")
```
:::

$$
Y_i \sim \operatorname{N}(\mu_i, \sigma^2_i)
$$

$$
\mu_i = \beta_0^{\mu} + \beta_{\text{trt}}^{\mu} \cdot \text{Trt}_i + \beta_{\text{year}}^{\mu}
\cdot \text{Year}_i + \beta_{\text{spp}}^{\mu} \cdot \text{Spp}_i +
\beta_{\text{spp:year}}^{\mu}(\text{Spp}_i \times \text{Year}_i) +
\alpha_{\text{tree}[i]} + \alpha_{\text{macro}[i],\text{spp}[i]}
$$

$$
\log(\sigma_i) = \beta^{\sigma}_0 + \beta^{\sigma}_{\text{trt}} \cdot \text{Trt}_i + \beta^{\sigma}_{\text{yr}}
\cdot \text{Year}_i + \beta^{\sigma}_{\text{spp}} \cdot \text{Spp}_i + \dots + \beta^{\sigma}_{\text{3way}}
(\text{Trt}_i \times \text{Year}_i \times \text{Spp}_i)
$$

$$
\alpha_{\text{tree}} \sim N(0, \sigma^2_{\text{tree}})
$$

$$
\alpha_{\text{macro}, \text{spp}} = \begin{pmatrix} \alpha_{\text{macro}_1, \text{spp}_1} \\
\alpha_{\text{macro}_1, \text{spp}_2} \\
\vdots \\ \alpha_{\text{macro}_j, \text{spp}_k} \end{pmatrix} \sim \operatorname{N}(\mathbf{0},
\boldsymbol{\Sigma}_{\text{macro}})
$$

- $Y_i$: Height increment (m yr^-1^) for sprout observation $i$.
- $\mu_i$: Mean height increment for observation $i$.
- $\sigma^2_i$: Variance of height increment for observation $i$.
- $\alpha^{\mu}_{\text{tree}}$: Random intercept for tree.
- $\alpha^{\mu}_{\text{macro}, \text{spp}}$: Random effect for species, co-varying
  within macro plot.
- $\boldsymbol{\Sigma}_{\text{macro}}$: Unstructured variance-covariance matrix for species
  within macro plot.

```{r}

ht_inc_treat <- marginaleffects_to_emmeans(
  model = minc_sel,
  newdata = NULL,
  x_var = "treat",
  by_var = "spp",
  contrast = list(treat = "pairwise")
)

# extract contrasts for each species into nested lists
rw_to_ht_pairs <-
  ht_inc_treat |>
  mutate(
    pairs = list(
      pairs(emmobj) |>
        as_tibble() |>
        mutate(across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = contrast) |>
        deframe()
    )
  ) |>
  select(spp, pairs) |>
  deframe()

rw_to_ht_mean <-
  ht_inc_treat |>
  mutate(
    emm = list(
      emmeans(emmobj, ~level) |>
        as_tibble() |>
        mutate(across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = level) |>
        deframe()
    )
  ) |>
  select(spp, emm) |>
  deframe()
```

The model selected based on AIC lacks a treatment x species interaction,
suggesting that there is not evidence that treatments affected species
differentially. It also lacks a treatment x year interaction. This means that
there was not enough evidence to support that treatment was related to changes
in growth rate.

The inclusion of treatment factors in the model (0.001 ≤ p < 0.03) indicated that
the levels of treatment were associated with different growth rates across
species and years. And the species x year interaction (p < 0.001) suggested that
changes in growth rates were different for redwood and tanoak
(@fig-sprout-ht-inc-treat).

For tanoak, height increment was greatest in the GS treatment at 
`r rw_to_ht_mean$LIDE$GS$estimate` m yr^-1^. 
This was about `r rw_to_ht_pairs$LIDE[["GS - HA"]]$estimate` m yr^-1^ 
more than in the HA and HD treatments,
which were very similar at about 
`r round(mean(c(rw_to_ht_mean$LIDE$HA$estimate, rw_to_ht_mean$LIDE$HD$estimate)), 1)`
m yr^-1^.

Redwood followed a similar pattern but with more pronounced differences between
treatments. Height increment for redwood in the GS treatment was 
`r rw_to_ht_mean$SESE$GS$estimate` m yr^-1^, 
which was about `r rw_to_ht_pairs$SESE[["GS - HD"]]$estimate` m yr^-1^ greater than in the HD
treatment (p = `r rw_to_ht_pairs$SESE[["GS - HD"]]$p.value`). 
Additionally, there was evidence that the GS treatment led to greater height increment than
the LD treatment by about `r rw_to_ht_pairs$SESE[["GS - LD"]]$estimate` m yr^-1^
(p = `r rw_to_ht_pairs$SESE[["GS - LD"]]$p.value`). And the LD treatment was
higher than the HA treatment by about `r rw_to_ht_pairs$SESE[["LD - HA"]]$estimate` m yr^-1^ 
(p = `r rw_to_ht_pairs$SESE[["LD - HA"]]$p.value`).

```{r}
#| label: fig-sprout-ht-inc-treat
#| fig-cap: >
#|   Estimated marginal means for the effect of harvest treatment on redwood and
#|   tanoak sprout height increment, averaged over two growth periods, ten years
#|   after harvest. Gray bars represent confidence intervals and statistical
#|   significance (α = 0.05) is indicated by non-overlapping blue arrows.

ht_inc_treat |>
  mutate(emm_df = list(emm_to_df_emm(emmobj))) |>
  select(spp, emm_df) |>
  unnest(emm_df) |>
  ggplot(emm_mapping(x = level)) +
  facet_wrap(~spp, ncol = 2, labeller = plot_labels) +
  draw_emm_emm() +
  labs(x = "Treatment", y = expression(Height ~ Increment ~ (m %.% yr^-1)))
```

```{r}
#| label: tbl-sprout-ht-inc-treat
#| tbl-cap: >
#|  Estimated marginal means for the effect of harvest treatment on redwood and
#|  tanoak sprout height increment, averaged over two growth periods, ten years
#|  after harvest. The asymptotic 95% confidence intervals are based on the
#|  normal approximation.

ht_inc_treat |>
  mutate(emm = list(as_tibble(emmeans(emmobj, ~level)))) |>
  select(spp, emm) |>
  unnest(everything()) |>
  select(-c(df)) |>
  mutate(spp = recode(spp, LIDE = "TO", SESE = "RW")) |>
  rename(Treat = level) |>
  rename(any_of(standard_model_col_names)) |>
  tinytable::tt(digits = 2) |>
  tinytable::format_tt(num_fmt = "decimal")
```


```{r}

ht_inc_year <- marginaleffects_to_emmeans(
  model = minc_sel,
  newdata = NULL,
  x_var = "year",
  by_var = "spp",
  contrast = list(year = "pairwise")
)

# extract contrasts for each species into nested lists
ht_inc_year_pairs <-
  ht_inc_year |>
  mutate(
    pairs = list(
      pairs(emmobj) |>
        as_tibble() |>
        mutate(across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = contrast) |>
        deframe()
    )
  ) |>
  select(spp, pairs) |>
  deframe()

ht_inc_year_mean <-
  ht_inc_year |>
  mutate(
    emm = list(
      emmeans(emmobj, ~level) |>
        as_tibble() |>
        mutate(across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = level) |>
        deframe()
    )
  ) |>
  select(spp, emm) |>
  deframe()

# ht_inc_year_mean$LIDE$`5`$estimate
# ht_inc_year_pairs$SESE$`level5 - level10`$estimate |> names()
```

Redwood growth slowed from 0.80 to 0.67 m yr^-1^ in the second period and tanoak
slowed from 0.39  to 0.34 m yr^-1^.

Redwood grew faster than tanoak, but slowed down more relative to it in the
second period. Height increment for redwood was 0.42 m yr^-1^ greater than
tanoak in the first period and 0.33 m yr^-1^ greater than tanoak in the second
period (@fig-sprout-ht-inc-year).


```{r}
#| label: fig-sprout-ht-inc-year
#| fig-cap: >
#|   Estimated marginal means for the effect of growth period on redwood and
#|   tanoak sprout height increment, averaged over four harvest treatments, from
#|   years 1 to 5, and years 5 to 10 after harvest, plotted alongside actual
#|   data. Gray bars represent confidence intervals and statistical significance
#|   (α = 0.05) is indicated by non-overlapping blue arrows.

ht_inc_year |>
  mutate(emm_df = list(emm_to_df_emm(emmobj))) |>
  select(spp, emm_df) |>
  unnest(emm_df) |>
  ggplot(emm_mapping(x = level)) +
  draw_emm_emm(position = position_nudge(x = -0.15)) +
  geom_dots(
    data = dinc,
    mapping = aes(x = year, y = ht_inc, xend = NULL, ymin = NULL, ymax = NULL),
    alpha = 0.4
  ) +
  facet_wrap(~spp, labeller = plot_labels) +
  scale_x_discrete(labels = c(`5` = "1 - 5", `10` = "5 - 10")) +
  labs(
    x = "Growth Period (years)",
    y = expression(Height ~ increment ~ (m %.% year^-1))
  )
```

```{r}
#| label: tbl-sprout-ht-inc-year
#| tbl-cap: >
#|   Estimated marginal means for the effect of growth period on redwood and
#|   tanoak sprout height increment, averaged over four harvest treatments, from
#|   years 1 to 5, and years 5 to 10 after harvest. The asymptotic 95%
#|   confidence intervals are based on the normal approximation.

ht_inc_year |>
  mutate(emm = list(as_tibble(emmeans(emmobj, ~level)))) |>
  select(spp, emm) |>
  unnest(everything()) |>
  mutate(spp = recode(spp, LIDE = "TO", SESE = "RW")) |>
  rename(Year = level) |>
  rename(any_of(standard_model_col_names)) |>
  tinytable::tt(digits = 2) |>
  tinytable::format_tt(num_fmt = "decimal")
```

### Height at year 10

Sprout heights at year 10 were modeled with a normal response and a log link.
The best model included species and treatment, but no interactions in the fixed
effects. This suggests that treatments do not affect species differentially in
terms of the mean response (height at year 10). It also included a model for
dispersion (log link) with predictors species, treatment, and their interaction
(@lst-sprout-ht-yr-10).

::: {#lst-sprout-ht-yr-10}
```{r}
print_model_info(ht10_sel, "disp")
```
:::

$$
Y_i \sim \operatorname{N}(\mu_i, \sigma^2_i)
$$

$$
\log(\mu_i) = \beta_0^{\mu} + \beta_{\text{trt}}^{\mu} \cdot \text{Trt}_i + \beta_{\text{spp}}^{\mu} \cdot \text{Spp}_i + \alpha_{\text{spp}[i], \text{macro}[i]}
$$

$$
\log(\sigma_i) = \beta^{\sigma}_0 + \beta^{\sigma}_{\text{trt}} \cdot
\text{Trt}_i + \beta^{\sigma}_{\text{spp}} \cdot \text{Spp}_i +
\beta^{\sigma}_{\text{trt:spp}}(\text{Trt}_i \times \text{Spp}_i)
$$

$$
\alpha_{\text{spp}, \text{macro}} = \begin{pmatrix} \alpha_{\text{spp}_1,
\text{macro}_1} \\ \alpha_{\text{spp}_1, \text{macro}_2} \\
\vdots \\ \alpha_{\text{spp}_j, \text{macro}_k} \end{pmatrix} \sim
\operatorname{N}(\mathbf{0}, \boldsymbol{\Sigma}_{\text{spp}, \text{macro}})
$$

- $Y_i$: Height at year 10 for tree $i$.
- $\mu_i$: Mean height at year 10 for tree $i$.
- $\sigma^2_i$: Variance of height at year 10 for tree $i$.
- $\alpha_{\text{macro}, \text{spp}}$: Random effect for species, co-varying
  within macro plot.
- $\boldsymbol{\Sigma}_{\text{macro}, \text{spp}}$: Unstructured variance-covariance matrix for species
  within macro plot.


```{r}
ht_year_10 <- marginaleffects_to_emmeans(
  model = ht10_sel,
  newdata = list(spp = unique, treat = unique, plot = unique),
  x_var = "treat",
  by_var = "spp",
  contrast = list(treat = "pairwise")
)

# extract contrasts for each species into nested lists
ht_year_10_pairs <-
  ht_year_10 |>
  mutate(
    pairs = list(
      pairs(emmobj) |>
        as_tibble() |>
        mutate(across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = contrast) |>
        deframe()
    )
  ) |>
  select(spp, pairs) |>
  deframe()

ht_year_10_mean <-
  ht_year_10 |>
  mutate(
    emm = list(
      emmeans(emmobj, ~level) |>
        as_tibble() |>
        mutate(across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = level) |>
        deframe()
    )
  ) |>
  select(spp, emm) |>
  deframe()
```

Because the best model did not contain a species x treatment interaction for the
mean response, treatment comparisons were parallel between species. The GS
treatment resulted in greater heights in year 10 than the other treatments
(0.001 < p < 0.05). Predicted mean height for redwood ranged from 
`r ht_year_10_mean$SESE$GS$estimate` m in the GS treatment to 
`r ht_year_10_mean$SESE$HD$estimate` m in the HD treatment. For tanoak, predicted mean height
ranged from `r ht_year_10_mean$LIDE$GS$estimate` m in the GS treatment to 
`r ht_year_10_mean$LIDE$HD$estimate` m in the HD treatment. Predicted mean
heights followed the pattern GS > LD > HA ≥ HD (@fig-sprout-ht-yr-10).

```{r}
#| label: fig-sprout-ht-yr-10
#| fig-cap: >
#|   Predicted mean height and 95% confidence intervals (gray bars) for redwood
#|   and tanoak stump sprouts 10 years after harvest using four different
#|   harvest treatments. Non-overlapping blue arrows indicate statistically
#|   significant differences between treatments within a species.

ht_year_10 |>
  mutate(emm_df = list(emm_to_df_emm(emmobj))) |>
  select(spp, emm_df) |>
  unnest(emm_df) |>
  ggplot(emm_mapping(x = level)) +
  draw_emm_emm(position = position_nudge(x = -0.15)) +
  geom_dots(
    data = filter(dht, year == 10),
    aes(x = treat, y = ht),
    alpha = 0.4,
    inherit.aes = FALSE
  ) +
  facet_wrap(~spp, labeller = plot_labels) +
  labs(x = "Treatment", y = "Height (m)")
```

```{r}
#| label: tbl-ht-year-10
#| tbl-cap: >
#|   Height (m) of measured redwood and tanaok sprouts 10 years after harvest
#|   treatments with four different over-story densities. The asymptotic 95%
#|   confidence intervals are based on the normal approximation.

ht_year_10 |>
  mutate(emm = list(as_tibble(emmeans(emmobj, ~level)))) |>
  select(spp, emm) |>
  unnest(everything()) |>
  select(-c(df)) |>
  mutate(spp = recode(spp, LIDE = "TO", SESE = "RW")) |>
  rename(Year = level) |>
  rename(any_of(standard_model_col_names)) |>
  tinytable::tt(digits = 2) |>
  tinytable::format_tt(num_fmt = "decimal")
```

```{r}
#| label: tbl-ht-year-10-compare
#| tbl-cap: >
#|  Pairwise comparisons of treatments within species for height (m) of
#|  measured redwood and tanoak sprouts 10 years after harvest. The P-values are
#|  based on the normal approximation.

ht_year_10 |>
  mutate(
    pairs = list(pairs(emmobj) |> as_tibble())
  ) |>
  select(spp, pairs) |>
  unnest(pairs) |>
  select(-c(z.ratio)) |>
  select(-c(df)) |>
  mutate(spp = recode(spp, LIDE = "TO", SESE = "RW")) |>
  rename(any_of(standard_model_col_names)) |>
  tinytable::tt() |>
  tinytable::format_tt(digits = 2, num_fmt = "decimal")
```

## Fuels

Gamma distributed, linear multi-level models, with a log link were used to model
fuel load response (Mg ha^-1^) for all fuel classes. Random intercepts were
specified for three levels of nesting, representing sites, macro plots, and
transect corners. A hurdle component with logit link was used for predicting
zeros in all models except for the duff & litter model. Dispersion components
were included where needed, based on AIC model selection. Models were fit
separately for pre- and post-PCT fuel measurements. Duff and litter were not
measured post-PCT, and vegetation difference was only modeled post-PCT.

:::{#lst-fuel-pre-pct-mod}
```
family: Gamma(link = "log")
conditional: fuel_load ~ treatment + (1 | site/macro/corner)
```
:::

$$
Y_i \sim \text{hurdle\_gamma}(\pi_i, \mu_i, \phi_i)
$$

$$
\log(\mu_i) = \beta^{\mu}_0 + \beta^{\mu}_{\text{trt}} \cdot \text{Trt}_i +
\alpha_{\text{site}[i]} + \alpha_{\text{macro}[i]} + \alpha_{\text{corner}[i]}
$$


Any model component not explicitly defined below was modeled with only an
intercept:

$$
\text{logit}(\pi_i^\cdot) = \beta^{(\pi,\cdot)}_0
$$

$$
\log(\phi_i^{\cdot}) = \beta^{(\phi,\cdot)}_0
$$

- $Y_i$: Fuel load (Mg ha^-1^) for transect $i$.
- $\pi_i$: Probability that $Y_i > 0$, the hurdle component.
- $\mu_i$: Mean of positive values.
- $\phi_i$: Dispersion parameter for Gamma distribution.
- $\alpha_{\cdot}$: Random intercepts for site, macro plot, and corner.
- $\beta^{\cdot}_{\cdot}$: Fixed effects for intercepts and treatment
  levels for mean, hurdle, and dispersion components
.


### Pre-pct

For the Duff & Litter model, there was no hurdle component because there were no
zeros in the data, and the dispersion parameter was modeled with only an
intercept (see below).

$$
\text{logit}(\pi_i^{\text{dufflitter}}) = \beta^{(\pi,\text{dufflitter})}_0
$$

For the 10-hr fuel model, the hurdle
and the dispersion components were modeled as functions of treatment.

$$
\text{logit}(\pi_i^{\text{10hr}}) = \beta^{(\pi,\text{10hr})}_0 +
\beta^{(\pi,\text{10hr})}_{\text{trt}} \cdot \text{Trt}_i
$$

$$
\log(\phi_i^{\text{10hr}}) = \beta^{(\phi,\text{10hr})}_0 +
\beta^{(\phi,\text{10hr})}_{\text{trt}} \cdot \text{Trt}_i
$$
.


```{r}
#| label: tbl-fuel-pre-pct-mod
#| tbl-cap: Dispersion and hurdle component specifications for six fuel classes before pct.

fuel_tmb$pre |>
  transmute(
    class = fuel_class_labels[as.character(class)],
    # Family = mod$modelInfo$family$family,
    # Link = mod$modelInfo$family$link,
    # Conditional = gsub("treatment", "trt", format_model_formula(mod, "cond")),
    "Dispersion (log)" = gsub(
      "treatment",
      "trt",
      format_model_formula(mod, "disp")
    ),
    "Hurdle (logit)" = gsub("treatment", "trt", format_model_formula(mod, "zi"))
  ) |>
  tinytable::tt()
```

```{r}

# Newdata in this case is repeating all combinations of random effects *found in
# the data* for each level of treatment. This should be the same approach as
# above but arrived at differently because above we have implicit grouping and
# nested variable coding, where as here we have explicit grouping, so when
# creating the we need to be explicit about the grouping.
fuel_tmb$pre <- mutate(
  fuel_tmb$pre,
  newdata = list(tidyr::expand(data, treatment, nesting(site, block, corner))),
  emmobj = list(marginaleffects_to_emmeans(
    model = mod,
    newdata = newdata,
    x_var = "treatment",
    by_var = NULL,
    contrast = list(treatment = "pairwise")
  ))
)

# extract contrasts for each species into nested lists for inline use
fuel_pre_compare <-
  fuel_tmb$pre |>
  mutate(
    pairs = list(
      pairs(emmobj) |>
        as_tibble() |>
        mutate(across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = contrast) |>
        deframe()
    )
  ) |>
  select(class, pairs) |>
  deframe()

fuel_pre_means <-
  fuel_tmb$pre |>
  mutate(
    emm = list(
      emmeans(emmobj, ~level) |>
        as_tibble() |>
        mutate(across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = level) |>
        deframe()
    )
  ) |>
  select(class, emm) |>
  deframe()
```

For Duff & Litter, the largest difference was between the HD and HA treatments.
The HD treatment had about `r fuel_pre_means$dufflitter$hd$estimate` Mg ha^-1^,
and was about `r abs(fuel_pre_compare$dufflitter[["ha - hd"]]$estimate)` Mg
ha^-1^ greater than the HA treatment (p = 
`r fuel_pre_compare$dufflitter[["ha - hd"]]$p.value`). Generally, all treatments
were similar, with estimated loading of around 
`r round(mean(map_dbl(fuel_pre_means$dufflitter, ~pluck(.x, "estimate"))), 0)`
Mg ha^-1^.

One-hour fuels were highest in the HA treatment, with an expected value of 
`r fuel_pre_means$onehr$ha$estimate` Mg ha^-1^, which was about 
`r fuel_pre_compare$onehr[["ha - gs"]]$estimate` Mg ha^-1^ greater than in the
GS treatment (p = `r fuel_pre_compare$onehr[["gs - ha"]]$p.value`). One-hour
fuels in the LD and HD treatments were intermediate but the LD was more similar
to the GS and the HD was more similar to the HA treatment.

Ten, hundred and thousand-hour fuels were statistically,
very similar across treatments (p ≥ 0.7). Treatment averages had 
maximum differences of around 1, 3, and 10 Mg ha^-1^ for ten, hundred, and thousand-hour fuels,
respectively. 

Vegetative fuel loading was greatest in the GS treatment, with an
expected value of `r fuel_pre_means$veg$gs$estimate` Mg ha^-1^, which was about `r fuel_pre_compare$veg[["gs - ha"]]$estimate` Mg ha^-1^ greater than in the HA
treatment (p = `r fuel_pre_compare$veg[["gs - ha"]]$p.value`) and LD and HD
treatments were intermediate. 
(@fig-fuel-pre-pct).

```{r}
#| label: fig-fuel-pre-pct
#| fig-width: 8
#| fig-cap: >
#|   Estimated marginal means (black dots) confidence intervals (gray bands) and
#|   comparisons (blue arrows) of fuel loading across four treatments for six
#|   different fuel-class models. Non-overlapping blue arrows indicates
#|   statistical significance at the α = 0.05 level.

fuel_tmb$pre |>
  mutate(class = fuel_class_labels[as.character(class)]) |>
  group_map(function(x, ...) {
    emm_to_df_emm(x$emmobj[[1]]) |>
      ggplot(emm_mapping(x = level)) +
      draw_emm_emm() +
      scale_x_discrete(labels = toupper) +
      labs(
        title = x$class,
        y = expression(Load ~ (Mg %.% ha^-1)),
        x = "Treatment"
      )
  }) |>
  patchwork::wrap_plots() +
  patchwork::plot_layout(axes = "collect")
```

```{r}
#| label: tbl-fuel-pre-pct-means
#| tbl-cap: >
#|  Estimated marginal means (Mg ha^-1^) for six fuel classes and four overstory
#|  treatments 10 years after partial harvest and prior to pre-commercial
#|  thinning (PCT). The asymptotic 95% confidence intervals are based on the
#|  normal approximation.

fuel_tmb$pre |>
  mutate(emmeans = list(as_tibble(emmeans(emmobj, ~level)))) |>
  select(class, emmeans) |>
  unnest(emmeans) |>
  mutate(class = fuel_class_labels[as.character(class)]) |>
  select(-c(df)) |>
  rename(treatment = level) |>
  rename(any_of(standard_model_col_names)) |>
  tinytable::tt(digits = 2, num_fmt = "decimal")
```

```{r}
#| label: tbl-fuel-pre-pct-compare
#| tbl-cap: >
#|   Pairwise comparisons of treatments for six fuel classes before pct.
#|   P-values were adjusted for multiple comparisons using the Tukey method and
#|   are based on normal approximations.

fuel_tmb$pre |>
  mutate(pairs = list(as_tibble(pairs(emmobj)))) |>
  select(class, pairs) |>
  unnest(pairs) |>
  select(-c(z.ratio)) |>
  select(-c(df)) |>
  arrange(p.value) |>
  mutate(class = fuel_class_labels[as.character(class)]) |>
  rename(any_of(standard_model_col_names)) |>
  tinytable::tt(digits = 2, num_fmt = "decimal")
```

```{r}
#| label: tbl-fuel-pre-pct-grand-means
#| tbl-cap: >
#|   Modeled grand means Mg ha^-1^ of fuel loading 10 years after harvest and
#|   prior to PCT. The asymptotic 95% confidence intervals are based on the
#|   normal approximation.

fuel_tmb$pre |>
  mutate(grand_mean = as_tibble(emmeans(emmobj, ~1))) |>
  select(c(class, grand_mean)) |>
  unnest(grand_mean) |>
  select(-c(df, `1`)) |>
  mutate(class = fuel_class_labels[as.character(class)]) |>
  rename(any_of(standard_model_col_names)) |>
  tinytable::tt(digits = 2, num_fmt = "decimal")
```

### Post-pct

After PCT, duff & litter was not modeled, vegetation difference was added. Model
selection resulted in somewhat more complex models for dispersion ($\phi$) and
hurdle ($\pi$) components. For 1-hr fuels the dispersion component included
treatment and site predictors:

$$
\log(\phi_i^{\text{1hr}}) = \beta^{(\phi,\text{1hr})}_0 +
\beta^{(\phi,\text{1hr})}_{\text{trt}} \cdot \text{Trt}_i + 
\beta^{(\phi,\text{1hr})}_{\text{site}} \cdot \text{Site}_i
$$
,

and for 100-hr fuels, the dispersion and hurdle components included treatment
and site predictors:

$$
\log(\phi_i^{\text{100hr}}) = \beta^{(\phi,\text{100hr})}_0 +
\beta^{(\phi,\text{100hr})}_{\text{trt}} \cdot \text{Trt}_i + 
\beta^{(\phi,\text{100hr})}_{\text{site}} \cdot \text{Site}_i
$$

$$
\text{logit}(\pi_i^{\text{100hr}}) = \beta^{(\pi,\text{100hr})}_0 +
\beta^{(\pi,\text{100hr})}_{\text{trt}} \cdot \text{Trt}_i + 
\beta^{(\pi,\text{100hr})}_{\text{site}} \cdot \text{Site}_i
$$
.

The dispersion and hurdle components for the rest of the fuel models included
only an intercept.

Dispersion models with treatment as the only predictor
were included for 1-hr and 100-hr fuel classes. All models included a hurdle
portion to model zeros using a logit link. For 100-hr fuels, the hurdle portion included
treatment and site as predictors. For the rest, a constant rate of zeros for all
observations was used (@tbl-fuel-post-pct).

```{r}
#| label: tbl-fuel-post-pct
#| tbl-cap: Model specifications for six fuel classes after pct.
fuel_tmb$post |>
  transmute(
    class = fuel_class_labels[as.character(class)],
    # Family = mod$modelInfo$family$family,
    # Link = mod$modelInfo$family$link,
    # Conditional = gsub("treatment", "trt", format_model_formula(mod, "cond")),
    "Dispersion (log)" = gsub(
      "treatment",
      "trt",
      format_model_formula(mod, "disp")
    ),
    "Hurdle (logit)" = gsub("treatment", "trt", format_model_formula(mod, "zi"))
  ) |>
  tinytable::tt()
```

```{r}
fuel_tmb$post <- mutate(
  fuel_tmb$post,
  newdata = list(tidyr::expand(data, treatment, nesting(site, block, corner))),
  emmobj = list(marginaleffects_to_emmeans(
    model = mod,
    newdata = newdata,
    x_var = "treatment",
    by_var = NULL,
    contrast = list(treatment = "pairwise")
  )),
  emmeans = list(emmeans::emmeans(emmobj, ~level) |> as_tibble()),
  pairs = list(pairs(emmobj) |> as_tibble())
)

# extract contrasts for each species into nested lists for inline use
fuel_post_compare <-
  fuel_tmb$post |>
  mutate(
    pairs = list(
      pairs(emmobj) |>
        as_tibble() |>
        mutate(across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = contrast) |>
        deframe()
    )
  ) |>
  select(class, pairs) |>
  deframe()

fuel_post_means <-
  fuel_tmb$post |>
  mutate(
    emm = list(
      emmeans(emmobj, ~level) |>
        as_tibble() |>
        mutate(across(where(is.double), \(x) round(x, 2))) |>
        nest(.by = level) |>
        deframe()
    )
  ) |>
  select(class, emm) |>
  deframe()

# [1] "onehr"    "tenhr"    "hundhr"   "thoushr"  "veg"      "veg_diff"
# [1] "gs - ld" "gs - ha" "gs - hd" "ld - ha" "ld - hd" "ha - hd"
# [1] "estimate"  "SE"        "df"        "asymp.LCL" "asymp.UCL"
```

Unlike pre-pct fuel loading which differed little among treatments in terms of
fine dead surface fuels, the PCT treatment resulted in additional fine dead
surface fuels that differed significantly among treatments. Whereas vegetation
fuel loading was reduced and differences between treatments were lessened.
Unlike pre-commercial thinning resulted in greater stratification of treatments
(@fig-fuel-post-pct). One-hour fuels for most treatments were around 
`r round(mean(map_dbl(discard_at(fuel_post_means$onehr, "ha"), ~pluck(.x, "estimate"))), 1)`
Mg ha^-1^, but the HA treatment was lower than these at about
`r fuel_post_means$onehr$ha$estimate` Mg ha^-1^ 
(p <= `r fuel_post_compare$onehr[["ha - gs"]]$p.value`).

The GS treatment had the greatest 10-hr fuel loading with `r fuel_post_means$tenhr$gs$estimate` Mg ha^-1^, which was
greater than the LD, HA, and HD treatments by  `r fuel_post_compare$tenhr[["gs - ld"]]$estimate`, `r fuel_post_compare$tenhr[["gs - ha"]]$estimate`, and `r fuel_post_compare$tenhr[["gs - hd"]]$estimate` Mg ha^-1^, respectively (
p = `r fuel_post_compare$tenhr[["gs - ld"]]$p.value`, 
p  < 0.001, and
p = `r fuel_post_compare$tenhr[["gs - hd"]]$p.value`).
The LD treatment also had about `r fuel_post_compare$tenhr[["ld - hd"]]$estimate` 
Mg ha^-1^ more 10-hr fuels that the HD treatment 
(p = `r fuel_post_compare$tenhr[["ld - hd"]]$p.value`). 

Hundred-hour fuels followed a similar trend as the 10-hr fuels. They were greatest in the GS
treatment, with an average of about `r fuel_post_means$hundhr$gs$estimate` Mg ha^-1^, 
which was about `r fuel_post_compare$hundhr[["gs - hd"]]$estimate` Mg ha^-1^ 
greater than the HD treatment (p = `r fuel_post_compare$hundhr[["gs - hd"]]$p.value`).

Thousand-hour fuels were greatest in the HD treatment, with an average of about `r fuel_post_means$thoushr$hd$estimate` Mg ha^-1^, which was about `r abs(fuel_post_compare$thoushr[["ld - hd"]]$estimate)` Mg ha^-1^ greater than the LD and HA treatments (p <= `r fuel_post_compare$thoushr[["ha - hd"]]$p.value`). The GS treatment was intermediate.

Fuel loading for live vegetation was similar across treatments at around 
`r round(mean(map_dbl(fuel_post_means$onehr, ~pluck(.x, "estimate"))), 1)`
Mg ha^-1^.  

The difference in vegetation loading before and after PCT was greatest in the GS treatment at
about `r fuel_post_means$veg_diff$gs$estimate` Mg ha^-1^, which was 
greater than the HA and HD treatments by about 
`r round(mean(map_dbl(keep_at(fuel_post_compare$veg_diff, c("gs - ha", "gs - hd")), "estimate")), 0)` 
Mg ha^-1^ (p = `r fuel_post_compare$veg_diff[["gs - hd"]]$p.value` and 
p = `r fuel_post_compare$veg_diff[["gs - ha"]]$p.value`, respectively). 
The LD treatment was intermediate.

```{r}
#| label: fig-fuel-post-pct
#| fig-width: 8
#| fig-cap: >
#|   Estimated marginal means (black dots) confidence intervals (gray bars) and
#|   statistical comparisons (blue arrows) of fuel loading across four
#|   treatments for six different fuel-class models. Non-overlapping blue arrows
#|   indicates statistical significance at the α = 0.05 level. Vegetation
#|   difference equals the transect level difference in vegetation load in the
#|   pre and post-pct conditions. This represents slash fuels recruited to the
#|   forest floor following the pre-commercial thinning.

fuel_tmb$post |>
  mutate(class = fuel_class_labels[as.character(class)]) |>
  group_map(function(x, ...) {
    emm_to_df_emm(x$emmobj[[1]]) |>
      ggplot(emm_mapping(x = level)) +
      draw_emm_emm() +
      scale_x_discrete(labels = toupper) +
      labs(
        title = x$class,
        y = expression(Load ~ (Mg %.% ha^-1)),
        x = "Treatment"
      )
  }) |>
  patchwork::wrap_plots() +
  patchwork::plot_layout(axes = "collect")
```

```{r}
#| label: tbl-fuel-post-pct-means
#| tbl-cap: >
#|  Estimated marginal means (Mg ha^-1^) for six fuel classes and four overstory
#|  treatments 10 years after partial harvest and after pre-commercial
#|  thinning (PCT). The asymptotic 95% confidence intervals are based on the
#|  normal approximation.

fuel_tmb$post |>
  mutate(
    emmeans = list(
      emmeans::emmeans(emmobj, ~level) |>
        as_tibble()
    )
  ) |>
  select(class, emmeans) |>
  unnest(emmeans) |>
  select(-c(df)) |>
  mutate(class = fuel_class_labels[as.character(class)]) |>
  rename(treatment = level) |>
  rename(any_of(standard_model_col_names)) |>
  tinytable::tt(digits = 2, num_fmt = "decimal")
```


```{r}
#| label: tbl-fuel-post-pct-compare
#| tbl-cap: >
#|   Pairwise comparisons of treatments for six fuel classes after pct. P-values
#|   were adjusted for multiple comparisons using the Tukey method and are based
#|   on normal approximations.

fuel_tmb$post |>
  mutate(
    pairs = list(
      pairs(emmobj) |>
        as_tibble()
    )
  ) |>
  select(class, pairs) |>
  unnest(pairs) |>
  select(-c(z.ratio)) |>
  arrange(p.value) |>
  select(-c(df)) |>
  mutate(class = fuel_class_labels[as.character(class)]) |>
  rename(any_of(standard_model_col_names)) |>
  tinytable::tt(digits = 2) |>
  tinytable::format_tt(num_fmt = "significant_cell")
```

```{r}
#| label: tbl-fuel-post-pct-grand-means
#| tbl-cap: >
#|   Modeled grand means Mg ha^-1^ of fuel loading 10 years after harvest and
#|   PCT. The asymptotic 95% confidence intervals are based on the normal
#|   approximation.

fuel_tmb$post |>
  mutate(grand_mean = as_tibble(emmeans(emmobj, ~1))) |>
  select(c(class, grand_mean)) |>
  unnest(grand_mean) |>
  select(-c(df, `1`)) |>
  mutate(class = fuel_class_labels[as.character(class)]) |>
  rename(any_of(standard_model_col_names)) |>
  tinytable::tt(digits = 2, num_fmt = "decimal")
```

### Pre-post commercial thinning comparison

The PCT of 10-year-old vegetation dramatically reduced live surface fuels,
predictably leading to varying increases in loading across 1- 10- and 100-hr
fuels. Specifically PCT led to a small increase in average 100-hr fuel loading,
only for the GS treatment, increased 10-hr fuels in the GS and LD treatments,
and increased 1-hr fuels for all but the HA treatment
(@fig-fuel-pct-comparison). However these results were not statistically
comparable, due to slightly different model structures.

```{r}
#| label: fig-fuel-pct-comparison
#| fig-width: 8
#| fig-cap: >
#|   Estimated marginal means (black dots) and confidence intervals (colored
#|   bars) of fuel loading across four treatments and five different fuel
#|   classes, before and after PCT. Pre- and Post PCT models within a treatment
#|   are from similar, but not necessarily identical models.

# pre and post together
fuel_tmb$pre |>
  # only use fuel classes that are the same between PCT phase
  filter(class %in% c("onehr", "tenhr", "hundhr", "thoushr", "veg")) |>
  group_map(function(x, ...) {
    # for each row in pre-treatment, get the pre-treatment data and the
    # corresponding data for post-treatment
    bind_rows(
      pre = emm_to_df_emm(x$emmobj[[1]]),
      post = emm_to_df(
        pluck(filter(fuel_tmb$post, class == x$class), "emmobj", 1)
      ),
      .id = "phase"
    ) |>
      ggplot(emm_mapping(
        x = level,
        color = factor(phase, levels = c("pre", "post")),
        group = factor(phase, levels = c("pre", "post"))
      )) +
      draw_emm2() +
      scale_x_discrete(labels = toupper) +
      scale_color_manual(
        labels = c("Pre-PCT", "Post-PCT"),
        values = c("#d17844", "#4444d1")
      ) +
      labs(
        title = fuel_class_labels[as.character(x$class)],
        y = expression(Load ~ (Mg %.% ha^-1)),
        x = "Treatment",
        color = "Phase"
      )
  }) |>
  patchwork::wrap_plots() +
  guide_area() +
  patchwork::plot_layout(
    axes = "collect_y",
    axis_title = "collect",
    guides = "collect"
  )
```

```{r}
#| include: false

# do the sum differences in 1, 10, and 100 equal the vegetation differences?

# combine pre and post dataframes
fuel_tmb$pre |>
  # only use fuel classes that are the same between PCT phase
  filter(class %in% c("onehr", "tenhr", "hundhr", "thoushr", "veg")) |>
  dplyr::group_map(function(x, ...) {
    # for each row in pre-treatment, get the pre-treatment data and the
    # corresponding data for post-treatment
    bind_rows(
      pre = emm_to_df_emm(x$emmobj[[1]]),
      post = emm_to_df(
        pluck(filter(fuel_tmb$post, class == x$class), "emmobj", 1)
      ),
      .id = "phase"
    ) |>
      mutate(class = x$class, .before = 1)
  }) |>
  bind_rows() |>
  # Calcualte difference
  select(class, phase, level, mean = Emmean) |>
  tidyr::pivot_wider(names_from = phase, values_from = mean) |>
  mutate(dif = post - pre) |>
  # ignore 1,000 hour
  filter(class != "thoushr") |>
  select(class, level, dif) |>
  # difference between Δfine-woody and Δveg
  pivot_wider(names_from = class, values_from = dif) |>
  mutate(
    fine = onehr + tenhr + hundhr,
    unaccounted = veg +
      fine
  )
```
