---
title: Reneration data summary
---

```{r}
#| output: false

library(tidyverse)
library(ggdist)
library(patchwork)

load("regen_wrangled.rda")
```

Some functions and constants that I need later on, these might should get moved
to their own function and sourced.

```{r}

# The metric foresters constant: diameter in cm to area of a circle in square
# meters
for_const <- function(dbh) {
  pi * dbh^2 / (4 * 10000)
}

# I need a mapping so that each species gets a unique color, I'll make this a
# function that takes a palette function from the scales package and returns a
# named vector

spp_col <- function(data, .palfun, ...) {
  pal <- .palfun(...)
  spp <- unique(data$spp)
  purrr::set_names(pal(length(spp)), spp)
}


```

## Objectives

- Determine if there are significant differences in species composition, or size
  class distirbution between treatments

This objective is somewhat vaugue because I am not familiar with the statistical
techniques used for the weighted (diameter), multi-variate (species)
distribution data that we have.

For starters, I will look at summaries of size class distributions by species. I
will report densities in terms of trees per hectare (tph). Our plots were fixed
area, 4-m-radius plots, or 50.27 m^2^. Each stem in a veg. plot represents
198.94 stems/ha. As shown in @fig-sampling-design, there are:

- 64 veg. plots in the experiment
- 16 in a treatment
- 4 in a macro plot

This plot is a little difficult to interpret beccause of the large difference in
counts from the smallest to largest stems. It might make more sense to look at
regen smaller than 5 cm separately.

```{r}
#| label: fig-raw-hist-regen-1
#| fig-cap: >
#|   Histogram of regen by species and size class for each treatment.

# expansion factors at different aggregation levels
per_ha <- c(
  all = 1/64, treat = 1/16, plot = 1/4, corner = 1) * (10000 / (16 * pi)
)

p <- regen |>
  ggplot(aes(dbh, fill = spp)) +
  stat_bin(aes(y = after_stat(count) * per_ha["treat"]), bins = 10) +
  facet_wrap(vars(treat), nrow = 1) +
  labs(y = expr(trees%.%ha^-1))
p

```

Splitting the analysis at 5-cm-diameter stems shows a clear trend in treatments
from most to least available light. Over this gradient, the number of 1.3-cm
stems increases, and the 3.8-cm stems decrease, almost proportionally --- and
most of this is due to tanoak. For >= 5-cm stems, the effect is a fairly
homogenous decrease in the number of stems. There are few tanoak, Douglas-fir
are only in the brightest areas. Mostly redwood (number of stems) shows a strong
correlation with available light.

```{r}
#| label: fig-raw-hist-regen-2
#| fig-cap: >
#|   Histograms of regen by species and size class. On top are stems less than
#|   five centimeters in diameter, and stems greater than five centimeters are
#|   on the bottom.

raw_hist2 <- function(group, bin_breaks, scale_breaks, text_pos) {
  generate_facet_totals <- function(data) {
    summarize(data,
      .by = treat,
      n = paste("Total: ", round(n() * per_ha["treat"])),
    )
  }
  colors <- spp_col(regen, scales::brewer_pal, palette = "Set2")
  regen |>
    filter({{ group }}) |>
    ggplot(aes(dbh, fill = forcats::fct_reorder(spp, spp, length))) +
    stat_bin(aes(y = after_stat(count) * per_ha["treat"]), breaks = bin_breaks) +
    ggpp::geom_text_npc(
      data = generate_facet_totals,
      aes(npcx = "center", npcy = "top", label = n, fill = NULL)
    ) +
    facet_wrap(vars(treat), nrow = 1) +
    labs(y = expression(trees %.% ha^-1), x = "dbh (cm)", fill = "spp") +
    scale_x_continuous(breaks = scale_breaks) +
    scale_y_continuous(expand = expansion(c(0.05, 0.2))) +
    scale_fill_manual(values = colors) +
    theme_bw()
}

raw_hist2(dbh < 5, seq(0, 17.5, 2.5), seq(0, 15, 5), c(2.5, 6000)) /
raw_hist2(dbh >= 5, seq(0, 17.5, 2.5), seq(0, 15, 5), c(27, 600))

```

This is interesting, but I wonder what this would look like in terms of basal
area, which is more biologically relevant than number of stems.

```{r}

local({
  bin_breaks <- seq(0, 17.5, 2.5)
  scale_breaks <- seq(0, 15, 5)
  facet_total_label <- function(data) {
    summarize(data,
      .by = treat,
      ba_ha = round(sum(per_ha["treat"] * for_const(dbh)), 1)
    )
  }
  regen |>
    ggplot(aes(dbh, fill = forcats::fct_reorder(spp, dbh, .fun = ~sum(.x^2)))) +
    stat_bin(aes(weight = per_ha["treat"] * for_const(dbh)), breaks = bin_breaks) +
    ggpp::geom_text_npc(
      data = facet_total_label,
      mapping = aes(npcx = "center", npcy = "top", label = ba_ha, fill = NULL)
    ) +
    facet_wrap(vars(treat), nrow = 1) +
    labs(y = expr(m^2 %.% ha^-1), x = "dbh (cm)", fill = "spp") +
    scale_y_continuous(expand = expansion(c(0.05, 0.2))) +
    scale_x_continuous(breaks = scale_breaks) +
    scale_fill_manual(values = spp_col(regen, scales::brewer_pal, palette = "Set2")) +
    theme_bw()
})

```

We decided that the minor species are not that interesting here, we are
grouping them into "other." I'll also order them they their prevelance which
will aid in plotting.

```{r}

# Reduce number of species
regen <- mutate(regen,
  spp = if_else(spp %in% c("rw", "to", "df"), spp, "other"),
  spp = forcats::fct_reorder(spp, spp, length),
)

```

What I would like to know is, are there significant differences between
treatments in terms of number of stems, or basal area each species and size
class. For instance, a hypothetical result might be: 

*GS has 30% more redwood stems and 20% more redwood basal area than LD for stems
larger than 2 cm (p = 0.02 and p = 0.001, respectively)*

*The HD treatment resulted in more Douglas-fir than the LD and GS treatments*

Save data from this page for future use

```{r}

save(regen, spp_col, per_ha, for_const, file = "regen_visualize.rda")

```
